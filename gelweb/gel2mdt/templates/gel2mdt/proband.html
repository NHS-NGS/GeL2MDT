<!--Copyright (c) 2018 Great Ormond Street Hospital for Children NHS Foundation
    Trust & Birmingham Women's and Children's NHS Foundation Trust

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
-->
{% extends 'gel2mdt/base.html' %}
{% load bootstrap3 %}
{% load static %}
{% block content %}
    {% load gel2mdt_extras %}

    {% if report.status == 'blocked' %}
        <div class="alert alert-danger" role="alert"><strong>Warning, the CIP-API status for this case has been changed to "Blocked"</strong></div>'
    {% endif %}
    <ul class="nav nav-tabs" data-options="deep_linking: true">
        <li class="active"><a data-toggle="tab" href="#proband">Proband</a></li>
        <li><a data-toggle="tab" href="#variants">Variants</a></li>
        <li><a data-toggle="tab" href="#history">History</a></li>
    </ul>
    {% block javascript %}
        <script src="{% static 'js/custom.js' %}"></script>
    {% endblock %}

    <div class="tab-content">
        <div id="proband" class="tab-pane fade in active">
            <div class="container-fluid" >
            <div style="text-align:right">
                {% if config_dict|get_item:'cip_as_id' == 'True' %}
                    <h1  style="text-align:left;float:left;">{{report.ir_family.ir_family_id}}</h1>
                {% else %}
                    <h1  style="text-align:left;float:left;">{{report.ir_family.participant_family.proband.gel_id}} </h1>
             {% endif %}

            </div>

                <form role="form" method="post" enctype="multipart/form-data" action="/update_proband/{{ report.id }}">
                    {% csrf_token %}
                    <div class="row">

                        <div class="col-md-12">
                            <div class="panel panel-default">
                                {% if gelir_form.case_status.value != "C" %}
                                    <div class="panel-heading">Participant Information <span style="float:right">
                                            {% if request.user.is_staff %}
                                                <a href="/update_demographics/{{report.id}}" class="btn btn-xs btn-info"> Update Demographics   </a>
                                            {% endif %}
                                            <a href=# data-toggle="modal" data-target="#demogModal"><i class="fas fa-pencil-alt"></i></a></span></div>
                                {% else %}
                                    <div class="panel-heading">Participant Information</div>
                                {% endif %}
                                <div class="panel-body">

                                    {% bootstrap_form_errors demogs_form %}

                                    <div class="col-md-3">
                                        {% bootstrap_label "GEL ID" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.gel_id}}
                                        </div>
                                        </br>
                                        {% bootstrap_label "NHS Number" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.nhs_number}}
                                        </div>
                                        </br>
                                        {% bootstrap_label "Date of Birth" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.date_of_birth|date}}
                                        </div>
                                        </br>
                                        {% bootstrap_label "GEL Sample ID" %}
                                        <div class="block">
                                            {{report.sample_id}}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        {% bootstrap_label "Forename" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.forename}}
                                        </div>
                                        </br>
                                        {% bootstrap_label "Sex" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.sex}}
                                        </div>
                                        </br>
                                      {% if report.sample_type == 'raredisease' %}
                                        {% bootstrap_label "Panels" %}
                                        <div class="block">

                                            {% for panel in panels %}
                                                <p>
                                                <a href="/panel/{{panel.panel.id}}">
                                                    {{panel.panel}}
                                                </a>
                                                </p>
                                            {% endfor %}
                                            <a href=# data-toggle="modal" data-target="#panelModal"><i class="fas fa-plus"></i></a>

                                        </div>
                                        </br>
                                    {% endif %}

                                    </div>


                                    <div class="col-md-3">

                                        {% bootstrap_label "Surname" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.surname}}
                                        </div>

                                        </br>
                                        {% bootstrap_label "Lab Number" %}
                                        <div class="block">
                                            {% if report.ir_family.participant_family.proband.lab_number %}
                                                {{ report.ir_family.participant_family.proband.lab_number }}
                                            {% else %}
                                                <p style="color:gray">unknown</p>
                                            {% endif %}
                                        </div>
                                        </br>
                                        {% bootstrap_label "Clinician" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.clinician}}
                                            <a href=# data-toggle="modal" data-target="#changeclinicianModal"><i class="fas fa-pencil-alt"></i></a>
                                            <a href=# data-toggle="modal" data-target="#addclinicianModal"><i class="fas fa-plus"></i></a>
                                        </div>
                                    </br>
                                    {% if other_cases %}
                                     {% bootstrap_label "Other Interpretations" %}
                                        <div class="block">

                                        {% for case in other_cases %}
                                            <a href="/proband/{{case.id}}">
                                                {{case.ir_family.ir_family_id}}</a>
                                        {% endfor %}


                                    </div>
                                    {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        {% bootstrap_label "CIP ID" %}
                                        <div class="block">
                                            <a href="https://cipapi.genomicsengland.nhs.uk/interpretationportal/#/participant/{{report.ir_family.ir_family_id}}" target="_blank"><i class="fas fa-external-link-alt"></i> {{report.ir_family.ir_family_id}}</a>
                                        </div>
                                        </br>
                                        {% bootstrap_label "Local ID" %}
                                        <div class="block">
                                            {% if report.ir_family.participant_family.proband.local_id %}
                                                {{ report.ir_family.participant_family.proband.local_id }}
                                            {% else %}
                                                <p style="color:gray">unknown</p>
                                            {% endif %}
                                        </div>
                                        </br>
                                        {% bootstrap_label "GMC" %}
                                        <div class="block">
                                            {{report.ir_family.participant_family.proband.gmc}}
                                        </div>
                                        </br>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                {% if report.sample_type == 'cancer' %}
                <div class=row>
                    <div class="col-md-12">

                        <div class="panel panel-default">
                            <div class="panel-heading">Clinical Information</div>
                            <div class="panel-body">
                                <div class="col-md-3">
                                    {% bootstrap_label "Recruiting Disease" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.recruiting_disease}}
                                    </div>
                                    </br>
                                    {% bootstrap_label "Disease Subtype" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.disease_subtype }}

                                    </div>
                                    </br>
                                    {% bootstrap_label "Deceased" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.deceased}}
                                    </div>
                                    </br>
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_label "Disease Grade" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.disease_grade}}
                                    </div>
                                    </br>
                                    {% bootstrap_label "Disease Stage" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.disease_stage }}

                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_label "Currently In Clinical Trial" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.currently_in_clinical_trial}}
                                    </div>
                                    </br>
                                    {% bootstrap_label "Current Clinical Trial Information" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.current_clinical_trial_info }}

                                    </div>
                                    </br>
                                    {% bootstrap_label "Suitable For Clinical Trial" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.suitable_for_clinical_trial }}

                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {% bootstrap_label "Previous Treatment" %}
                                    <div class="block">
                                        {{report.ir_family.participant_family.proband.previous_treatment}}
                                    </div>
                                    </br>
                                    {% bootstrap_label "Previous Testing" %}
                                    <div class="block">
                                            {{ report.ir_family.participant_family.proband.previous_testing }}

                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    {% endif %}



                    <div class=row>
                        <div class="col-md-7">

                            <div class="panel panel-default">
                                <div class="panel-heading">Proband Tracking</div>
                                <div class="panel-body">
                                    <div class="col-md-6">

                                        {% bootstrap_field proband_form.outcome %}

                                    </div>
                                    <div class="col-md-6">

                                        {% bootstrap_field proband_form.comment %}
                                        {% bootstrap_label "Assigned User" %}
                                        <br>

                                        <a href=# data-toggle="modal" data-target="#caseAssignModal"><i class="fas fa-user-plus"></i></a>
                                        {{ report.assigned_user.first_name }} {{ report.assigned_user.last_name }}

                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="col-md-5">

                            <div class="panel panel-default">
                                <div class="panel-heading">Status</div>
                                <div class="panel-body">
                                    <div class="col-md-12">
                                        {% bootstrap_field gelir_form.case_status %}
                                        {% if report.sample_type == 'raredisease'%}
                                        {% bootstrap_field gelir_form.mdt_status %}
                                        {% else %}
                                        {% bootstrap_field gelir_form.mdt_status label='GTAB Status' %}
                                        {% endif %}
                                        {% bootstrap_label "CIP-API status" %} &emsp; {{ report.status }}
                                    </div>

                                    <div class="col-md-2">
                                        {% bootstrap_field gelir_form.case_sent %}
                                    </div>
                                    <div class="col-md-2">
                                        {% bootstrap_field gelir_form.pilot_case %}
                                    </div>
                                    {% if report.sample_type == "cancer" %}
                                    <div class="col-md-3">
                                        {% bootstrap_field gelir_form.no_primary_findings label="No Actionable Findings" %}
                                    </div>
                                    {% else %}
                                    <div class="col-md-3">
                                        {% bootstrap_field gelir_form.no_primary_findings label="No Primary Findings" %}
                                    </div>
                                    {% endif %}
                                    <div class="col-md-3">
                                        {% bootstrap_field gelir_form.case_code label='Case Code' %}
                                    </div>
                                    {% if proband_mdt|length > 0 %}
                                        <div class="col-md-2">
                                            <a href="/export_mdt_outcome_form/{{report.id}}"><i class="fas fa-external-link-alt"></i> MDM Outcome</a>
                                        </div>
                                    {% endif %}
                                    <div class="col-md-12">
                                        {% if gelir_form.case_status.value != "C" %}
                                            </br>
                                            <button type="submit" name="variant_update" class="btn btn-primary btn">Save</button>
                                        {% elif request.user.is_staff %}
                                            </br>
                                            <button type="submit" name="variant_update" class="btn btn-primary btn">Save</button>
                                        {% endif %}


                                        {% if config_dict|get_item:'show_clinical_report' == 'True' %}
                                            <span>
                                                <a href="/genomics_england_report/{{report.id}}" class="btn btn-warning" role="button">Clinical Report</a>
                                            </span>
                                        {% endif %} 


                                        <span style="float: right; margin: 0px 5px 0px 5px">
                                            <a href="/proband/{{report.id}}/report/negative" target="_blank" class="btn btn-info" role="button">Negative Report</a>
                                        </span>
                                        <span style="float: right; margin: 0px 5px 0px 5px">
                                            <a href="#" data-toggle="modal" data-target="#reportingModal" class="btn btn-warning" role="button">Positive Report</a>
                                        </span>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div id="reportingModal" class="modal fade" role="dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                <h4 class="modal-title">Variants for Reporting</h4>
                            </div>

                            <div class="modal-body">
                                        {% if variants_for_reporting %}
                                <table class="table table-bordered table-condensed">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-plus-circle"></i></th>
                                            <th>Gene</th>
                                            <th>HGVS description</th>
                                            <th>Classification</th>
                                            </th>
                                    </thead>
                                    <tbody>
                                        {% for variant in variants_for_reporting %}
                                            <tr>
                                            <td><div class="checkbox">
                                                    <label><input type="checkbox" name="reportVariantChoice" value="{{variant.id}}"></label>
                                                </div></td>
                                                <td>{{variant.proband_variant.get_transcript.gene}}</td>
                                                <td>
                                                    {{variant.proband_variant.get_transcript_variant.hgvs_c}}
                                                    {% if variant.proband_variant.get_transcript_variant.hgvs_p %}
                                                        <br>
                                                        {{variant.proband_variant.get_transcript_variant.hgvs_p}}
                                                    {% endif %}
                                                </td>
                                                <td>{{variant.classification}}</td>
                                            </tr>
                                            {% endfor %}
                                    </tbody>
                                </table>
                                <a target="_blank" id="btnSendVariants" class="btn btn-active" role="button">Generate</a>
                                {%else%}
                                    <p>No class 3, 4, or 5 variants which have passed validation found for this patient.</p>
                                    {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

    <script>
        $(document).ready(function() {
            $("#btnSendVariants").click(function() {
                var url="/proband/{{report.id}}/report/positive?rdr=";
                var flag=false;
                $("input:checkbox[name=reportVariantChoice]:checked").each(function() {
                    if (!flag) {
                        url=url+$(this).val();
                        flag=true;
                    } else {
                        url=url+"&rdr="+$(this).val();
                    }
                })
                window.open(url, '_blank');
           })
        })
    </script>

                {% if proband_mdt %}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">MDT History</div>
                                <div class="panel-body">
                                    <div class="col-md-15">
                                        <table width="100%" class="table table-striped table-bordered table-hover">
                                            <thead>
                                                <tr>
                                                    {% if report.sample_type == 'raredisease' %}
                                                    <th>MDT Name</th>
                                                    <th>MDT Date</th>
                                                        {% else %}
                                                        <th>GTAB Name</th>
                                                    <th>GTAB Date</th>
                                                        {% endif  %}
                                                    <th>Status</th>
                                                    <th>Creator</th>

                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for mdt in proband_mdt %}
                                                    <tr>
                                                        <td><a href="/mdt_view/{{ mdt.MDT.id }}">{{ mdt.MDT.id }}</a></td>
                                                        <td>{{mdt.MDT.date_of_mdt|date}}</td>
                                                        <td>{{mdt.MDT.get_status_display}}</td>
                                                        <td>{{mdt.MDT.creator}}</td>

                                                    </tr>
                                                {% endfor %}


                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if relatives %}
                    <div class=row>
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">Relatives</div>
                                <div class="panel-body">
                                    <table width="100%" class="table table-striped table-bordered table-hover" id="relative-table">
                                        <thead>
                                            <tr>
                                                <th>Relationship</th>
                                                <th>Forename</th>
                                                <th>Surname</th>
                                                <th>DOB</th>
                                                <th>NHS number</th>
                                                <th>ID</th>
                                                <th>Affection_status</th>
                                                <th>Edit Relative</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for relative in relatives %}
                                                <tr>

                                                    <td>{{relative.relation_to_proband}}</td>
                                                    <td>{{relative.forename}}</td>
                                                    <td>{{relative.surname}}</td>
                                                    <td>{{relative.date_of_birth|date}}</td>
                                                    <td>{{relative.nhs_number}}</td>
                                                    <td>{{relative.gel_id}}</td>
                                                    <td>{{relative.affected_status}}</td>
                                                    <td><button type="button" class="btn btn-xs btn-danger js-edit-relative"
                                                                              data-url="/edit_relative/{{ relative.id }}">
                                                            Edit
                                                        </button></td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}


            </div>

        <div id="variants" class="tab-pane fade">
            <div class="container-fluid" >
                {% if config_dict|get_item:'cip_as_id' == 'True' %}
                    <h1>{{report.ir_family.ir_family_id}}</h1>
                {% else %}
                    <h1>{{report.ir_family.participant_family.proband.gel_id}}</h1>
                {% endif %}
                <div class="row">

                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">Participant Information</div>
                            <div class="panel-body">
                                <div class="container-fluid" >
                                    <div class="row">

                                        <div class="col-md-2">
                                            {% bootstrap_label "GEL ID" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.gel_id}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "Forename" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.forename}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "Surname" %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.surname}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% bootstrap_label "CIP ID" %}
                                            <div class="block">
                                                <a href="https://cipapi.genomicsengland.nhs.uk/interpretationportal/#/participant/{{report.ir_family.ir_family_id}}" target="_blank">{{report.ir_family.ir_family_id}}</a>
                                            </div>
                                        </div>
                                        {% if config_dict|get_item:'pull_T3' == 'False' %}
                                            <div class="col-md-2">
                                                {% bootstrap_label "Pull Tier3 Variants" %}
                                                <div class="block">
                                                    <a href="/pull_t3_variants/{{report.id}}">Link</a>
                                                </div>
                                            </div>
                                        {% endif %}
                                        <div class="col-md-2">
                                            {% bootstrap_label "Add a new variant" %}
                                            <div class="block">
                                                <a href=# data-toggle="modal" data-target="#addvariantModal"><i class="fas fa-plus"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">

                                        <div class="col-md-2">
                                            {% if report.sample_type == 'raredisease'%}
                                            {% bootstrap_label "MDT Discussion" %}
                                            {% else %}
                                            {% bootstrap_label "GTAB Discussion" %}
                                            {% endif %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.discussion}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            {% if report.sample_type == 'raredisease'%}
                                            {% bootstrap_label "MDT Action" %}
                                            {% else %}
                                            {% bootstrap_label "GTAB Action" %}
                                            {% endif %}
                                            <div class="block">
                                                {{report.ir_family.participant_family.proband.action}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
                <div class="row">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="dataTables-pv">
                            <thead style='font-size: 75%'>
                                <tr>
                                    <th>Variant</th>
                                    <th>Interpretation</th>
                                    <th>Gene</th>
                                {% if report.sample_type == 'cancer' %}
                                    <th>Domain</th>
                                {% else %}
                                    <th>Tier</th>
                                {% endif %}
                                    <th>Flag</th>
                                    <th>Transcript</th>
                                    <th>HGVSc</th>
                                    <th>HGVSp</th>
                                    <th>Genotype</th>
                                    {% if report.sample_type == 'cancer' %}
                                    <th>Somatic status</th>
                                    {% else %}
                                    <th>Inheritance</th>
                                    {% endif %}
                                    <th>Validation Status</th>
                                </tr>
                            </thead>
                            <tbody style='font-size: 75%'>

                                {% for pv, pv_form in pv_forms_dict.items %}
                                    <tr >
                                        <td>
                                            <a href="/variant/{{pv.variant.id }}">
                                                <i class="fas fa-external-link-alt fa-2x"></i>
                                            </a>
                                        </td>
                                        <td>
                                            <a href=# data-toggle="modal" data-target="#pvModal{{forloop.counter}}">
                                                <i class="fas fa-info-circle fa-2x"></i>
                                            </a>
                                        </td>

                                        <div id="pvModal{{forloop.counter}}" class="modal fade" role="dialog">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                        <h4 class="modal-title">MDT Results</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        <label>Variant Classification</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.get_classification_display }}
                                                        <hr>
                                                        <label>Contribution to Phenotype</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.contribution_to_phenotype }}
                                                        <hr>
                                                        <label>Action from MDT</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.action }}
                                                        <hr>
                                                        <label>MDT Discussion</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.discussion }}
                                                        <hr>
                                                        <label>Change Medication?</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.change_med }}
                                                        <hr>
                                                        <label>Surgical Option?</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.surgical_option }}
                                                        <hr>
                                                        <label>Add Relative Surveillance?</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.add_surveillance_for_relatives }}
                                                        <hr>
                                                        <label>Add Clinical Trial?</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.clinical_trial }}
                                                        <hr>
                                                        <label>Inform Reproductive Choice?</label>
                                                        <br>
                                                        {{ pv.rarediseasereport.inform_reproductive_choice }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                        <td>{{ pv.get_transcript.gene }}</td>
                                        <td>{{ pv.max_tier }}</td>

                                        <td style="word-wrap: break-word; min-width: 75px;max-width: 75px;">{% for flag in pv.pvflag_set.all %}
                                        {{flag}};
                                        {% endfor %}</td>

                                        <td>
                                            {% if gelir_form.case_status.value != "C" %}
                                                <a href="/select_transcript/{{report.id}}/{{pv.id }}"><i class="fas fa-pencil-alt"></i></a></span> {{pv.get_transcript.name }}
                                        {% else%}
                                            {{pv.get_transcript.name }}
                                        {% endif %}
                                        </td>

                                        <td style="word-wrap: break-word; min-width: 100px;max-width: 100px;">{{pv.get_transcript_variant.hgvs_c}}</td>
                                        <td style="word-wrap: break-word; min-width: 75px;max-width: 75px;">{{pv.get_transcript_variant.hgvs_p}}</td>
                                        <td>{{pv.zygosity}}</td>
                                        {% if report.sample_type == 'cancer' %}
                                        <td>{{pv.somatic}}</td>
                                        {% else %}
                                        <td>{{pv.inheritance}}</td>
                                        {% endif %}
                                        <td><a onclick="$('#validationModal{{forloop.counter}}').modal('show')"><i class="fas fa-pencil-alt"></i></a></span> {{pv.get_validation_status_display}}</td>
                                    </tr>

                                    <div id="validationModal{{forloop.counter}}" class="modal fade validationModal" role="dialog">
                                        <p class="pv-id" hidden>{{pv.id}}</p>
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                                                    <h4 class="modal-title">{{pv.get_transcript_variant.hgvs_c}}</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <h5>Validation for variant {{pv.get_transcript_variant.hgvs_c}}.</h5>
                                                    <form id="validationForm{{forloop.counter}}" action="#" method="POST">
                                                        {% csrf_token %}
                                                        {% bootstrap_form pv_form %}
                                                        {% buttons %}
                                                        <input value="Update" type="button" onclick="updateValidation(validationModal{{forloop.counter}});" class="btn btn-primary">
                                                        </input>
                                                        {% endbuttons %}
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                {% endfor %}

                                <script>
                                    function updateValidation(modalID) {
                                        var modal = $(modalID);
                                        var CSRFToken = modal.find('input[name=csrfmiddlewaretoken]').val();
                                        var modalTitle = modal.find('.modal-title');
                                        var pvID = modal.find('.pv-id').text();
                                        console.log("Updating validation for " + modalTitle.text() + " (" + pvID + ").");
                                        var select_status = modal.find('#id_validation_status');
                                        var select_status_value = select_status.find(":selected").text();
                                        var select_user = modal.find('#id_validation_responsible_user');
                                        var select_user_value = select_user.find(":selected").text();
                                        console.log("Setting validation status as " + select_status_value);
                                        console.log("Setting validation user as " + select_user_value);
                                        $.ajax({
                                            type: 'POST',
                                            url: '/ajax_validation',
                                            data: {
                                                probandVariant: pvID,
                                                selectedStatus: select_status_value,
                                                selectedUser: select_user_value,
                                                csrfmiddlewaretoken: CSRFToken
                                            },
                                            success: function(response) {
                                                console.log("POSTed validation change:");
                                                console.log(response);
                                                select_status.find(":selected").text(response.validationStatus);
                                                select_user.find(":selected").text(response.validationUser);
                                                location.reload();
                                            }
                                        })

                                    }
                                </script>

                            </tbody>
                        </table>
                    </div>

                </div>
                </div>
            </div>
        </div>


    <div id="history" class="tab-pane fade">
            <div class="container-fluid" >
                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">Report History</div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered table-hover" >
                            <thead style='font-size: 75%'>
                                <tr>
                                    <th>User </th>
                                    <th>Date Changed</th>
                                    <th>assigned_user</th>
                                    <th>case_sent</th>
                                    <th>case_status</th>
                                    <th>mdt_status</th>
                                    <th>pilot_case</th>
                                    <th>no_primary_findings</th>
                                </tr>
                            </thead>
                            <tbody style='font-size: 75%'>
                                {% for history in report_history %}
                                     {%  if forloop.counter0  == 0 %}
                                     {% if history.diff.0 %}
                                     <tr>
                                    <td>{{ history.revision.user}}</td>
                                    <td>{{ history.revision.date_created }}</td>
                                     {% for field in report_fields %}
                                     {% if field in history.diff.1 %}
                                         <td>{{ history.serialized_data.0.fields|get_item:field }}</td>
                                     {% else %}
                                         <td></td>
                                     {% endif %}
                                         {% endfor %}
                                    {% endif %}
                                    {% else %}
                                    {% if history.diff.0 %}
                                     <tr>
                                    <td>{{ history.revision.user}}</td>
                                    <td>{{ history.revision.date_created }}</td>
                                     {% for field in report_fields %}
                                     {% if field in history.diff.1 %}
                                         <td bgcolor="#90ee90">{{ history.serialized_data.0.fields|get_item:field }}</td>
                                     {% else %}
                                         <td></td>
                                     {% endif %}
                                         {% endfor %}
                                    {% endif %}
                                    {% endif %}

    {% endfor %}
                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    <div class="panel panel-default">
                            <div class="panel-heading">Proband History</div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-bordered table-hover" >
                            <thead style='font-size: 75%'>
                                <tr>
                                    <th>User </th>
                                    <th>Date Changed</th>
                                    <th>forename</th>
                                    <th>surname</th>
                                    <th>date_of_birth</th>
                                    <th>nhs_number</th>
                                    <th>sex</th>
                                    <th>outcome</th>
                                    <th>comment</th>
                                    <th>discussion</th>
                                    <th>action</th>
                                    <th>gmc</th>
                                    <th>lab_number</th>
                                    <th>local_id</th>
                                    <th>deceased</th>
                                    <th>disease_group</th>
                                    <th>recruiting_disease</th>
                                    <th>disease_subtype</th>
                                    <th>disease_stage</th>
                                    <th>disease_grade</th>
                                    <th>currently_in_clinical_trial</th>
                                    <th>current_clinical_trial_info</th>
                                    <th>suitable_for_clinical_trial</th>
                                    <th>previous_testing</th>
                                    <th>previous_treatment</th>
                                </tr>
                            </thead>
                            <tbody style='font-size: 75%'>
                                {% for history in proband_history %}
                                     {%  if forloop.counter0  == 0 %}
                                     {% if history.diff.0 %}
                                     <tr>
                                    <td>{{ history.revision.user}}</td>
                                    <td>{{ history.revision.date_created }}</td>
                                     {% for field in proband_fields %}
                                     {% if field in history.diff.1 %}
                                         <td>{{ history.serialized_data.0.fields|get_item:field }}</td>
                                     {% else %}
                                         <td></td>
                                     {% endif %}
                                         {% endfor %}
                                    {% endif %}
                                    {% else %}
                                    {% if history.diff.0 %}
                                     <tr>
                                    <td>{{ history.revision.user}}</td>
                                    <td>{{ history.revision.date_created }}</td>
                                     {% for field in proband_fields %}
                                     {% if field in history.diff.1 %}
                                         <td bgcolor="#90ee90">{{ history.serialized_data.0.fields|get_item:field }}</td>
                                     {% else %}
                                         <td></td>
                                     {% endif %}
                                         {% endfor %}
                                    {% endif %}
                                    {% endif %}

    {% endfor %}
                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </div>


    <div id="caseAssignModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Assign case to user</h4>
                </div>
                <div class="modal-body">

                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form case_assign_form %}
                        {% buttons %}
                        <button type="submit" class="btn btn-primary">
                            Update
                        </button>
                        {% endbuttons %}
                    </form>

                </div>
            </div>
        </div>
    </div>

    <div id="demogModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Edit proband information</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form demogs_form %}
                        {% buttons %}
                        <button type="submit" class="btn btn-primary">
                            Update
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="panelModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Add Panel</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form panel_form %}
                        {% buttons %}
                        <button type="submit" class="btn btn-primary">
                            Change
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="changeclinicianModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Change Clinician</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form clinician_form %}
                        {% buttons %}
                        <button type="submit" class="btn btn-primary">
                            Change Clinician
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="addclinicianModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Add New Clinician</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form add_clinician_form %}
                        {% buttons %}
                        <button type="submit" class="btn btn-primary">
                            Add New Clinician
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="addvariantModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><i class="fas fa-window-close"></i></button>
                    <h4 class="modal-title">Add New Variant</h4>
                </div>
                <div class="modal-body">
                    <form action="/proband/{{ report.id }}" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form add_variant_form %}
                        {% buttons %}
                        <button type="submit" class="btn btn-primary">
                            Add New Variant
                        </button>
                        {% endbuttons %}
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="modal-relative">
        <div class="modal-dialog">
            <div class="modal-content">
            </div>
        </div>
    </div>

{% endblock %}
